From 6d78366500e105fb435da2250a3fe165faff00c5 Mon Sep 17 00:00:00 2001
From: Stephen Gallagher <sgallagh@redhat.com>
Date: Mon, 10 Jan 2011 11:18:47 -0500
Subject: [PATCH 2/2] Notify WSGI users that config changes are needed

When upgrading from 1.5.1 or older, we should inform users that
changes are required to their WSGI configuration to support the
API properly
---
 reviewboard/cmdline/rbsite.py |   15 +++++++++++++++
 1 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/reviewboard/cmdline/rbsite.py b/reviewboard/cmdline/rbsite.py
index d07f7590695f8c20a6c7501f86fe449135e1ef17..345d6f7c72c30d2004a32426643ced199fd0de54 100755
--- a/reviewboard/cmdline/rbsite.py
+++ b/reviewboard/cmdline/rbsite.py
@@ -1575,6 +1575,7 @@ class UpgradeCommand(Command):
 
     def run(self):
         site.setup_settings()
+        os.environ["DJANGO_SETTINGS_MODULE"] = "reviewboard.settings"
 
         data_dir_exists = os.path.exists(os.path.join(site.install_dir, "data"))
 
@@ -1585,6 +1586,12 @@ class UpgradeCommand(Command):
             print "Upgrading site settings_local.py"
             site.upgrade_settings()
 
+        from djblets.siteconfig.models import SiteConfiguration
+        siteconfig = SiteConfiguration.objects.get_current()
+        print "Upgrading from version %s" % str(siteconfig.version)
+
+        version = [int(x) for x in siteconfig.version.split(' ')[0].split('.')]
+
         if options.upgrade_db:
             print "Updating database. This may take a while."
             site.sync_database()
@@ -1609,6 +1616,14 @@ class UpgradeCommand(Command):
             print "    SetEnv HOME %s" % os.path.join(site.abs_install_dir,
                                                       "data")
 
+        if version[0] < 1 or (version[0] == 1 and (version[1] < 5 or (version[1] == 5 and version[2] < 2))):
+            print "############################################################################################"
+            print "# Warning: your configuration may require an update                                        #"
+            print "# If you are running ReviewBoard on mod_wsgi, you need to update your Apache configuration #"
+            print "# as described at:                                                                         #"
+            print "# http://www.reviewboard.org/docs/releasenotes/dev/reviewboard/1.5.2/#important-updates    #"
+            print "############################################################################################"
+
 
 class ManageCommand(Command):
     """
-- 
1.7.4

